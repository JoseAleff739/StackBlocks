<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>StackBlocks</title>

  <style>
    /* Importa a fonte Press Start 2P do Google Fonts para dar estilo retro ao jogo */
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    /* Reset b√°sico de CSS para garantir consist√™ncia entre navegadores */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Press Start 2P', monospace;
    }

    /* Estiliza√ß√£o do corpo da p√°gina */
    body {
      background-color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      color: #fff;
    }

    /* Container principal do jogo com layout em grid */
    .game-container {
      background-color: rgba(0, 0, 0, 0.75);
      display: grid;
      grid-template-columns: 1fr 2fr 1fr; /* Sidebar esquerda, canvas central, sidebar direita */
      grid-template-rows: auto auto;
      gap: 20px;
      padding: 20px;
      border-radius: 10px;
      max-width: 1000px;
      width: 90vw;
    }

    /* Estiliza√ß√£o das barras laterais (score e pr√≥xima pe√ßa) */
    .sidebar, .next-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 10px;
      background-color: #111;
      border: 3px solid red;
      height: 600px;
      justify-content: flex-start;
      font-size: 14px;
      border-radius: 5px;
    }

    /* Estiliza√ß√£o dos elementos dentro das sidebars */
    .sidebar div, .next-container canvas {
      background-color: #222;
      padding: 10px;
      border: 2px solid #555;
      text-align: center;
      border-radius: 3px;
    }

    /* Canvas principal onde o jogo acontece */
    canvas#tetris {
      background-color: #000;
      border: 4px solid #fff;
      border-radius: 5px;
    }

    /* Container dos bot√µes de controle */
    .controls {
      grid-column: span 3; /* Ocupa todas as 3 colunas */
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }

    /* Estiliza√ß√£o padr√£o dos bot√µes */
    button {
      padding: 12px 20px;
      font-size: 14px;
      background-color: #222;
      color: #fff;
      border: 2px solid #fff;
      cursor: pointer;
      transition: background 0.2s ease;
      border-radius: 5px;
      user-select: none;
    }

    /* Efeito hover nos bot√µes */
    button:hover {
      background-color: #fff;
      color: #000;
    }

    /* Cores espec√≠ficas para bot√µes importantes */
    button#start { border-color: #00ff00; }
    button#restart { border-color: orange; }
    button#pause { border-color: red; }

    /* Tela de Game Over */
    #gameOverScreen {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.9);
      color: red;
      font-size: 32px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-family: 'Press Start 2P', monospace;
      display: none;
      z-index: 10;
    }

    #gameOverScreen p { margin-bottom: 20px; }

    /* Menu dropdown de configura√ß√µes */
    .menu-dropdown {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }

    .menu-dropdown button {
      border: 2px solid #555;
      background-color: #222;
      color: #ccc;
      font-size: 12px;
      padding: 6px 12px;
      cursor: pointer;
    }

    /* Conte√∫do do dropdown */
    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      top: 40px;
      background-color: rgba(17,17,17,0.98);
      border: 2px solid #555;
      border-radius: 8px;
      padding: 15px;
      min-width: 250px;
      font-size: 12px;
      color: #ccc;
      max-height: 400px;
      overflow-y: auto;
    }

    .dropdown-content button {
      width: 100%;
      margin: 4px 0;
      font-size: 12px;
      padding: 4px 0;
    }

    .dropdown-content input[type=range] {
      width: 100%;
    }

    /* Popup de instru√ß√µes/tutorial */
    #instructionsPopup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(0,0,0,0.95) 0%, rgba(20,0,40,0.95) 100%);
      color: #fff;
      font-family: 'Press Start 2P', monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 20;
      overflow-y: auto;
      padding: 20px;
    }

    /* Container do tutorial */
    .tutorial-container {
      background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
      padding: 30px;
      border-radius: 20px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 0 50px rgba(0, 255, 255, 0.3);
      border: 3px solid #00ff00;
      animation: slideIn 0.5s ease-out;
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Anima√ß√£o de entrada do tutorial */
    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Cabe√ßalho do tutorial */
    .tutorial-header {
      text-align: center;
      margin-bottom: 30px;
      position: relative;
    }

    .tutorial-header h1 {
      color: #00ff00;
      font-size: 28px;
      margin-bottom: 10px;
      text-shadow: 0 0 10px #00ff00;
      animation: glow 2s ease-in-out infinite;
    }

    /* Anima√ß√£o de brilho do t√≠tulo */
    @keyframes glow {
      0%, 100% { text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00; }
      50% { text-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00; }
    }

    .tutorial-header p {
      color: #aaa;
      font-size: 12px;
      line-height: 1.6;
    }

    /* Se√ß√µes do tutorial */
    .tutorial-section {
      margin: 25px 0;
      padding: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      border-left: 4px solid #00ff00;
    }

    .tutorial-section h2 {
      color: #00ffff;
      font-size: 16px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tutorial-section h2::before {
      content: '‚ñ∂';
      color: #00ff00;
      animation: blink 1.5s infinite;
    }

    /* Anima√ß√£o de piscar */
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Grid de demonstra√ß√£o de controles */
    .controls-demo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    /* Item individual de controle */
    .control-item {
      background: rgba(0, 255, 0, 0.1);
      padding: 15px;
      border-radius: 8px;
      border: 2px solid rgba(0, 255, 0, 0.3);
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .control-item:hover {
      background: rgba(0, 255, 0, 0.2);
      border-color: #00ff00;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
    }

    .control-item .key {
      font-size: 24px;
      color: #00ff00;
      margin-bottom: 8px;
      display: block;
    }

    .control-item .action {
      font-size: 10px;
      color: #aaa;
      line-height: 1.4;
    }

    /* Showcase das pe√ßas do jogo */
    .pieces-showcase {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }

    /* Demonstra√ß√£o individual de cada pe√ßa */
    .piece-demo {
      text-align: center;
      animation: float 3s ease-in-out infinite;
    }

    /* Delays diferentes para cada pe√ßa criar efeito de flutua√ß√£o */
    .piece-demo:nth-child(1) { animation-delay: 0s; }
    .piece-demo:nth-child(2) { animation-delay: 0.2s; }
    .piece-demo:nth-child(3) { animation-delay: 0.4s; }
    .piece-demo:nth-child(4) { animation-delay: 0.6s; }
    .piece-demo:nth-child(5) { animation-delay: 0.8s; }
    .piece-demo:nth-child(6) { animation-delay: 1s; }
    .piece-demo:nth-child(7) { animation-delay: 1.2s; }

    /* Anima√ß√£o de flutua√ß√£o */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .piece-demo canvas {
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      background: rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
    }

    .piece-demo:hover canvas {
      border-color: #00ff00;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
      transform: scale(1.1);
    }

    .piece-demo .piece-name {
      font-size: 10px;
      color: #00ffff;
      margin-top: 8px;
    }

    /* Lista de dicas */
    .tips-list {
      list-style: none;
      padding: 0;
    }

    .tips-list li {
      padding: 10px;
      margin: 8px 0;
      background: rgba(255, 255, 0, 0.1);
      border-left: 3px solid #ffff00;
      border-radius: 5px;
      font-size: 11px;
      line-height: 1.6;
      color: #ddd;
      transition: all 0.3s ease;
    }

    .tips-list li:hover {
      background: rgba(255, 255, 0, 0.2);
      transform: translateX(5px);
    }

    .tips-list li::before {
      content: 'üí° ';
      margin-right: 5px;
    }

    /* Bot√£o de iniciar do tutorial */
    .start-button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 30px auto 0;
      padding: 15px 30px;
      font-size: 16px;
      background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Press Start 2P', monospace;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    /* Anima√ß√£o de pulso do bot√£o */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .start-button:hover {
      background: linear-gradient(135deg, #00ff00 0%, #00ff00 100%);
      box-shadow: 0 8px 25px rgba(0, 255, 0, 0.5);
      transform: translateY(-2px);
    }

    .start-button:active {
      transform: translateY(0);
      box-shadow: 0 3px 10px rgba(0, 255, 0, 0.3);
    }

    /* Nota para dispositivos m√≥veis */
    .mobile-note {
      background: rgba(255, 0, 255, 0.1);
      border: 2px solid rgba(255, 0, 255, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
      font-size: 11px;
      color: #ff00ff;
      line-height: 1.6;
    }

    .mobile-note::before {
      content: 'üì± ';
      font-size: 20px;
      display: block;
      margin-bottom: 10px;
    }

    /* ============================================
       üöÄ EASTER EGG: INDICADOR DO MODO TURBO üöÄ
       ============================================
       Este elemento exibe uma mensagem animada quando
       o jogador ativa o modo turbo (3 toques r√°pidos no START)
    */
    #turboMode {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #ff0000 0%, #ff6600 100%);
      color: #fff;
      padding: 30px 50px;
      border-radius: 20px;
      font-size: 32px;
      font-family: 'Press Start 2P', monospace;
      text-align: center;
      box-shadow: 0 0 50px rgba(255, 0, 0, 0.8);
      z-index: 100;
      display: none; /* Oculto por padr√£o */
      animation: turboAppear 0.5s ease-out;
    }

    /* Anima√ß√£o de apari√ß√£o do indicador turbo */
    @keyframes turboAppear {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2);
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    /* Quando o modo turbo est√° ativo */
    #turboMode.active {
      display: block;
      animation: turboAppear 0.5s ease-out, turboPulse 0.5s ease-in-out infinite 0.5s;
    }

    /* Anima√ß√£o de pulso do indicador turbo */
    @keyframes turboPulse {
      0%, 100% {
        box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
      }
      50% {
        box-shadow: 0 0 60px rgba(255, 0, 0, 1), 0 0 90px rgba(255, 102, 0, 0.8);
      }
    }

    /* Responsividade para dispositivos m√≥veis */
    @media (max-width: 768px) {
      .tutorial-container {
        padding: 20px;
        margin: 10px;
      }

      .tutorial-header h1 {
        font-size: 20px;
      }

      .tutorial-section h2 {
        font-size: 14px;
      }

      .controls-demo {
        grid-template-columns: repeat(2, 1fr);
      }

      .control-item .key {
        font-size: 20px;
      }

      .pieces-showcase {
        gap: 10px;
      }

      .start-button {
        font-size: 14px;
        padding: 12px 24px;
      }

      /* üöÄ EASTER EGG: Ajuste do indicador turbo para mobile */
      #turboMode {
        font-size: 20px;
        padding: 20px 30px;
      }
    }

    /* Estiliza√ß√£o da barra de rolagem */
    .tutorial-container::-webkit-scrollbar,
    .dropdown-content::-webkit-scrollbar {
      width: 10px;
    }

    .tutorial-container::-webkit-scrollbar-track,
    .dropdown-content::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }

    .tutorial-container::-webkit-scrollbar-thumb,
    .dropdown-content::-webkit-scrollbar-thumb {
      background: #00ff00;
      border-radius: 10px;
    }

    .tutorial-container::-webkit-scrollbar-thumb:hover,
    .dropdown-content::-webkit-scrollbar-thumb:hover {
      background: #00cc00;
    }
  </style>
</head>
<body>

  <!-- Container principal do jogo -->
  <div class="game-container">
    <!-- Sidebar esquerda com informa√ß√µes do jogo -->
    <div class="sidebar">
      <div id="score">SCORE: <span>0</span></div>
      <div id="time">TIME: <span>0</span>s</div>
      <div id="lines">LINE: <span>0</span></div>
      <div id="combo">COMBO: <span>0</span></div>
    </div>

    <!-- Canvas principal onde o jogo acontece -->
    <canvas id="tetris" width="300" height="600"></canvas>

    <!-- Sidebar direita mostrando a pr√≥xima pe√ßa -->
    <div class="next-container">
      <canvas id="next" width="120" height="120"></canvas>
    </div>

    <!-- Bot√µes de controle do jogo -->
    <div class="controls">
      <button id="left">‚óÄ</button>
      <button id="right">‚ñ∂</button>
      <button id="down">‚ñº</button>
      <button id="rotate">‚ü≥</button>
      <button id="start">START</button>
      <button id="pause">PAUSE</button>
      <button id="restart">RESTART</button>
    </div>
  </div>

  <!-- Tela de Game Over -->
  <div id="gameOverScreen">
    <p>GAME OVER</p>
    <p>Pressione tecla E para reiniciar</p>
  </div>

  <!-- üöÄ EASTER EGG: Indicador visual do Modo Turbo
       Este elemento aparece quando o jogador toca 3 vezes r√°pidas no bot√£o START -->
  <div id="turboMode">
    üöÄ MODO TURBO üöÄ<br>
    <span style="font-size: 16px; margin-top: 10px; display: block;">ATIVADO!</span>
  </div>

  <!-- Popup de instru√ß√µes/tutorial -->
  <div id="instructionsPopup">
    <div class="tutorial-container">
      <div class="tutorial-header">
        <h1>üéÆ STACKBLOCKS üéÆ</h1>
        <p>Bem-vindo ao jogo de blocos mais viciante!</p>
      </div>

      <div class="tutorial-section">
        <h2>üéØ Objetivo do Jogo</h2>
        <p style="font-size: 11px; line-height: 1.6; color: #ccc;">
          Complete linhas horizontais para elimin√°-las e ganhar pontos! 
          Quanto mais linhas voc√™ completar de uma vez, mais pontos voc√™ ganha. 
          O jogo termina quando as pe√ßas atingem o topo da tela.
        </p>
      </div>

      <div class="tutorial-section">
        <h2>‚å®Ô∏è Controles</h2>
        <div class="controls-demo">
          <div class="control-item">
            <span class="key">‚óÄ</span>
            <span class="action">Mover Esquerda</span>
          </div>
          <div class="control-item">
            <span class="key">‚ñ∂</span>
            <span class="action">Mover Direita</span>
          </div>
          <div class="control-item">
            <span class="key">‚ñº</span>
            <span class="action">Descer R√°pido</span>
          </div>
          <div class="control-item">
            <span class="key">‚ü≥</span>
            <span class="action">Rotacionar</span>
          </div>
        </div>
      </div>

      <div class="mobile-note">
        <strong>JOGANDO NO CELULAR?</strong><br>
        Use os bot√µes na tela para controlar as pe√ßas!<br>
        Toque nos bot√µes ‚óÄ ‚ñ∂ ‚ñº ‚ü≥ para mover e rotacionar.
      </div>

      <div class="tutorial-section">
        <h2>üß© Conhe√ßa as Pe√ßas</h2>
        <p style="font-size: 10px; color: #aaa; margin-bottom: 15px;">
          Passe o mouse sobre as pe√ßas para v√™-las brilhar!
        </p>
        <div class="pieces-showcase">
          <div class="piece-demo">
            <canvas class="pieceCanvas" width="60" height="60" data-piece="I"></canvas>
            <div class="piece-name">LINHA</div>
          </div>
          <div class="piece-demo">
            <canvas class="pieceCanvas" width="60" height="60" data-piece="O"></canvas>
            <div class="piece-name">QUADRADO</div>
          </div>
          <div class="piece-demo">
            <canvas class="pieceCanvas" width="60" height="60" data-piece="T"></canvas>
            <div class="piece-name">T</div>
          </div>
          <div class="piece-demo">
            <canvas class="pieceCanvas" width="60" height="60" data-piece="L"></canvas>
            <div class="piece-name">L</div>
          </div>
          <div class="piece-demo">
            <canvas class="pieceCanvas" width="60" height="60" data-piece="J"></canvas>
            <div class="piece-name">J</div>
          </div>
          <div class="piece-demo">
            <canvas class="pieceCanvas" width="60" height="60" data-piece="S"></canvas>
            <div class="piece-name">S</div>
          </div>
          <div class="piece-demo">
            <canvas class="pieceCanvas" width="60" height="60" data-piece="Z"></canvas>
            <div class="piece-name">Z</div>
          </div>
        </div>
      </div>

      <div class="tutorial-section">
        <h2>üíé Dicas Pro</h2>
        <ul class="tips-list">
          <li>Deixe espa√ßos para a pe√ßa LINHA (I) - ela elimina 4 linhas de uma vez!</li>
          <li>Mantenha a superf√≠cie o mais plana poss√≠vel para evitar buracos.</li>
          <li>Use a rota√ß√£o para encaixar pe√ßas em espa√ßos apertados.</li>
          <li>Fique de olho na pr√≥xima pe√ßa no painel lateral direito.</li>
          <li>Combos consecutivos aumentam sua pontua√ß√£o exponencialmente!</li>
        </ul>
      </div>

      <button class="start-button" id="closeInstructions">
        COME√áAR A JOGAR! üöÄ
      </button>
    </div>
  </div>

  <!-- Elementos de √°udio -->
  <audio id="pieceSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
  <audio id="bgMusic" src="https://files.catbox.moe/3pgllj.mp3" preload="auto" loop></audio>

  <!-- Menu dropdown de configura√ß√µes -->
  <div class="menu-dropdown">
    <div style="position: relative;">
      <button id="settingsToggle">‚öôÔ∏è Configura√ß√µes</button>
      <div class="dropdown-content" id="settingsContent">
        <p><strong>M√∫sica de Fundo: TO ZANARKAND</strong></p>
        <button id="musicPlay">‚ñ∂ Play</button>
        <button id="musicPause">‚è∏ Pausar</button>
        <label for="musicVolume">Volume:</label>
        <input type="range" id="musicVolume" min="0" max="1" step="0.01" value="0.5">
      </div>
    </div>
  </div>

<script>
  // ========================================
  // L√ìGICA PRINCIPAL DO JOGO
  // ========================================
  
  // Obt√©m refer√™ncias aos elementos canvas e seus contextos 2D
  const canvas = document.getElementById('tetris');
  const ctx = canvas.getContext('2d');
  const nextCanvas = document.getElementById('next');
  const nextCtx = nextCanvas.getContext('2d');

  // Obt√©m refer√™ncias aos elementos HTML que exibem informa√ß√µes do jogo
  const scoreEl = document.querySelector('#score span');
  const timeEl = document.querySelector('#time span');
  const linesEl = document.querySelector('#lines span');
  const comboEl = document.querySelector('#combo span');
  const gameOverScreen = document.getElementById('gameOverScreen');

  // Cria a arena do jogo (matriz 10x20 onde as pe√ßas caem)
  let arena = createMatrix(10, 20);
  
  // Vari√°veis de controle do tempo de queda das pe√ßas
  let dropCounter = 0;
  let dropInterval = 1000; // Intervalo inicial de queda (1 segundo)
  let lastTime = 0;
  let startTime = 0;
  
  // Flags de estado do jogo
  let gameOver = false;
  let turboMode = false; // üöÄ EASTER EGG: Flag que indica se o modo turbo est√° ativo

  // Objeto que armazena o estado do jogador
  let player = {
    pos: {x:0, y:0},      // Posi√ß√£o atual da pe√ßa
    matrix: null,          // Matriz da pe√ßa atual
    score: 0,              // Pontua√ß√£o
    lines: 0,              // Linhas completadas
    combo: 0,              // Combo atual
    next: null             // Pr√≥xima pe√ßa
  };

  // ============================================
  // üöÄ EASTER EGG: DETEC√á√ÉO DE TOQUE TRIPLO üöÄ
  // ============================================
  // Array que armazena os timestamps dos toques no bot√£o START
  let startButtonTaps = [];
  // Janela de tempo para detectar os 3 toques (1 segundo)
  const TRIPLE_TAP_WINDOW = 1000;
  // Quantidade de toques necess√°rios para ativar o easter egg
  const TRIPLE_TAP_COUNT = 3;

  /**
   * Cria uma matriz vazia com as dimens√µes especificadas
   * @param {number} w - Largura da matriz
   * @param {number} h - Altura da matriz
   * @returns {Array} Matriz preenchida com zeros
   */
  function createMatrix(w, h){
    const matrix = [];
    while(h--) matrix.push(new Array(w).fill(0));
    return matrix;
  }

  /**
   * Cria uma pe√ßa do Tetris baseada no tipo fornecido
   * @param {string} type - Tipo da pe√ßa (T, O, L, J, I, S, Z)
   * @returns {Array} Matriz representando a forma da pe√ßa
   */
  function createPiece(type){
    switch(type){
      case 'T': return [[0,0,0],[1,1,1],[0,1,0]];
      case 'O': return [[2,2],[2,2]];
      case 'L': return [[0,3,0],[0,3,0],[0,3,3]];
      case 'J': return [[0,4,0],[0,4,0],[4,4,0]];
      case 'I': return [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]];
      case 'S': return [[0,6,6],[6,6,0],[0,0,0]];
      case 'Z': return [[7,7,0],[0,7,7],[0,0,0]];
      default: return [[0]];
    }
  }

  /**
   * Desenha uma matriz (pe√ßa ou arena) no canvas
   * @param {Array} matrix - Matriz a ser desenhada
   * @param {Object} offset - Posi√ß√£o de offset {x, y}
   * @param {CanvasRenderingContext2D} context - Contexto do canvas
   */
  function drawMatrix(matrix, offset, context){
    matrix.forEach((row, y) => {
      row.forEach((value, x) => {
        if(value !== 0){
          // Define a cor baseada no valor da c√©lula usando HSL
          context.fillStyle = `hsl(${value*45}, 80%, 60%)`;
          context.fillRect((x + offset.x) * 30, (y + offset.y) * 30, 30, 30);
          context.strokeStyle = '#000';
          context.strokeRect((x + offset.x) * 30, (y + offset.y) * 30, 30, 30);
        }
      });
    });
  }

  /**
   * Desenha a pr√≥xima pe√ßa no canvas de preview
   */
  function drawNextPiece(){
    // Limpa o canvas
    nextCtx.fillStyle = '#000';
    nextCtx.fillRect(0, 0, nextCanvas.width, nextCanvas.height);
    
    if(player.next){
      const cellSize = 20;
      // Centraliza a pe√ßa no canvas
      const offsetX = (nextCanvas.width - player.next[0].length * cellSize) / 2;
      const offsetY = (nextCanvas.height - player.next.length * cellSize) / 2;
      
      player.next.forEach((row, y) => {
        row.forEach((value, x) => {
          if(value !== 0){
            nextCtx.fillStyle = `hsl(${value*45}, 80%, 60%)`;
            nextCtx.fillRect(offsetX + x*cellSize, offsetY + y*cellSize, cellSize, cellSize);
            nextCtx.strokeStyle = '#000';
            nextCtx.strokeRect(offsetX + x*cellSize, offsetY + y*cellSize, cellSize, cellSize);
          }
        });
      });
    }
  }

  /**
   * Mescla a pe√ßa atual com a arena quando ela pousa
   * @param {Array} arena - Matriz da arena
   * @param {Object} player - Objeto do jogador
   */
  function merge(arena, player){
    player.matrix.forEach((row, y) => {
      row.forEach((value, x) => {
        if(value !== 0) arena[y + player.pos.y][x + player.pos.x] = value;
      });
    });
  }

  /**
   * Verifica se h√° colis√£o entre a pe√ßa e a arena
   * @param {Array} arena - Matriz da arena
   * @param {Object} player - Objeto do jogador
   * @returns {boolean} True se houver colis√£o
   */
  function collide(arena, player){
    const [m, o] = [player.matrix, player.pos];
    for(let y = 0; y < m.length; y++){
      for(let x = 0; x < m[y].length; x++){
        if(m[y][x] !== 0 && (arena[y + o.y] && arena[y + o.y][x + o.x]) !== 0) 
          return true;
      }
    }
    return false;
  }

  /**
   * Move a pe√ßa para baixo
   */
  function playerDrop(){
    player.pos.y++;
    // Se colidir, volta uma posi√ß√£o e mescla com a arena
    if(collide(arena, player)){
      player.pos.y--;
      merge(arena, player);
      playerReset();
      sweep();
      updateScore();
      document.getElementById('pieceSound').play();
    }
    dropCounter = 0;
  }

  /**
   * Move a pe√ßa horizontalmente
   * @param {number} dir - Dire√ß√£o (-1 para esquerda, 1 para direita)
   */
  function playerMove(dir){
    player.pos.x += dir;
    // Se colidir, desfaz o movimento
    if(collide(arena, player)) player.pos.x -= dir;
  }

  /**
   * Reseta a pe√ßa do jogador com uma nova pe√ßa
   */
  function playerReset(){
    const pieces = 'ILJOTSZ';
    // Define a pe√ßa atual como a pr√≥xima, ou cria uma aleat√≥ria
    player.matrix = player.next || createPiece(pieces[pieces.length * Math.random() | 0]);
    // Gera a pr√≥xima pe√ßa
    player.next = createPiece(pieces[pieces.length * Math.random() | 0]);
    player.pos.y = 0;
    // Centraliza a pe√ßa horizontalmente
    player.pos.x = (arena[0].length / 2 | 0) - (player.matrix[0].length / 2 | 0);
    
    // Verifica se h√° colis√£o no spawn (Game Over)
    if(collide(arena, player)){
      arena.forEach(row => row.fill(0));
      gameOverScreen.style.display = 'flex';
      gameOver = true;
    }
  }

  /**
   * Rotaciona uma matriz 90 graus
   * @param {Array} matrix - Matriz a ser rotacionada
   * @param {number} dir - Dire√ß√£o da rota√ß√£o (1 ou -1)
   */
  function rotate(matrix, dir){
    // Transp√µe a matriz
    for(let y = 0; y < matrix.length; y++){
      for(let x = 0; x < y; x++){
        [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]];
      }
    }
    // Inverte as linhas ou colunas dependendo da dire√ß√£o
    if(dir > 0) matrix.forEach(row => row.reverse());
    else matrix.reverse();
  }

  /**
   * Rotaciona a pe√ßa do jogador com wall kick
   */
  function playerRotate(dir){
    rotate(player.matrix, dir);
    let offset = 1;
    // Tenta ajustar a posi√ß√£o se houver colis√£o ap√≥s rota√ß√£o
    while(collide(arena, player)){
      player.pos.x += offset;
      offset = -(offset + (offset > 0 ? 1 : -1));
      if(offset > player.matrix[0].length){
        rotate(player.matrix, -dir);
        player.pos.x = 0;
        return;
      }
    }
  }

  /**
   * Verifica e remove linhas completas
   */
  function sweep(){
    let rowCount = 1;
    outer: for(let y = arena.length - 1; y >= 0; y--){
      // Verifica se a linha est√° completa
      for(let x = 0; x < arena[y].length; x++){
        if(arena[y][x] === 0) continue outer;
      }
      // Remove a linha e adiciona uma nova no topo
      const row = arena.splice(y, 1)[0].fill(0);
      arena.unshift(row);
      // Aumenta a pontua√ß√£o
      player.score += rowCount * 10;
      player.lines++;
      player.combo++;
      rowCount *= 2;
      y++;
    }
  }

  /**
   * Atualiza a exibi√ß√£o da pontua√ß√£o na tela
   */
  function updateScore(){
    scoreEl.innerText = player.score;
    linesEl.innerText = player.lines;
    comboEl.innerText = player.combo;
  }

  /**
   * Loop principal do jogo
   * @param {number} time - Timestamp atual
   */
  function update(time = 0){
    const deltaTime = time - lastTime;
    lastTime = time;
    dropCounter += deltaTime;
    
    // Se o contador atingir o intervalo, desce a pe√ßa
    if(dropCounter > dropInterval && !gameOver) playerDrop();
    
    // Limpa o canvas
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Desenha a arena e a pe√ßa atual
    drawMatrix(arena, {x:0, y:0}, ctx);
    drawMatrix(player.matrix, player.pos, ctx);
    drawNextPiece();
    
    // Continua o loop
    requestAnimationFrame(update);
  }

  // ============================================
  // üöÄ EASTER EGG: FUN√á√ÉO DE ATIVA√á√ÉO DO MODO TURBO üöÄ
  // ============================================
  /**
   * Ativa o modo turbo, acelerando a queda das pe√ßas
   * Esta fun√ß√£o √© chamada quando o jogador toca 3 vezes r√°pidas no bot√£o START
   */
  function activateTurboMode(){
    turboMode = true;
    // Reduz o intervalo de queda para 300ms (velocidade 3x mais r√°pida)
    dropInterval = 300;
    
    // Exibe o indicador visual do modo turbo
    const turboIndicator = document.getElementById('turboMode');
    turboIndicator.classList.add('active');
    
    // Remove o indicador ap√≥s 2 segundos
    setTimeout(() => {
      turboIndicator.classList.remove('active');
    }, 2000);
  }

  // ============================================
  // üöÄ EASTER EGG: FUN√á√ÉO DE DETEC√á√ÉO DE TOQUE TRIPLO üöÄ
  // ============================================
  /**
   * Verifica se o jogador tocou 3 vezes r√°pidas no bot√£o START
   * @returns {boolean} True se o modo turbo foi ativado
   */
  function checkTripleTap(){
    const now = Date.now();
    
    // Adiciona o timestamp do toque atual ao array
    startButtonTaps.push(now);
    
    // Remove toques que est√£o fora da janela de tempo (1 segundo)
    startButtonTaps = startButtonTaps.filter(tapTime => now - tapTime < TRIPLE_TAP_WINDOW);
    
    // Verifica se h√° 3 ou mais toques dentro da janela de tempo
    if(startButtonTaps.length >= TRIPLE_TAP_COUNT){
      activateTurboMode(); // Ativa o modo turbo
      startButtonTaps = []; // Reseta o array de toques
      return true;
    }
    
    return false;
  }

  // ========================================
  // EVENT LISTENERS - CONTROLES DO TECLADO
  // ========================================
  document.addEventListener('keydown', event => {
    // Reinicia o jogo se estiver em Game Over e pressionar 'E'
    if(gameOver && event.key === 'e'){
      gameOverScreen.style.display = 'none';
      gameOver = false;
      player.score = 0;
      player.lines = 0;
      player.combo = 0;
      turboMode = false; // üöÄ EASTER EGG: Reseta o modo turbo
      dropInterval = 1000; // üöÄ EASTER EGG: Restaura velocidade normal
      playerReset();
      updateScore();
      return;
    }
    
    // Controles do jogo
    if(event.key === 'ArrowLeft') playerMove(-1);
    if(event.key === 'ArrowRight') playerMove(1);
    if(event.key === 'ArrowDown') playerDrop();
    if(event.key === 'ArrowUp') playerRotate(1);
    if(event.key === ' ') playerRotate(1);
  });

  // ========================================
  // EVENT LISTENERS - BOT√ïES NA TELA
  // ========================================
  
  // Bot√µes de movimento
  document.getElementById('left').addEventListener('click', () => playerMove(-1));
  document.getElementById('right').addEventListener('click', () => playerMove(1));
  document.getElementById('down').addEventListener('click', () => playerDrop());
  document.getElementById('rotate').addEventListener('click', () => playerRotate(1));
  
  // üöÄ EASTER EGG: Bot√£o START com detec√ß√£o de toque triplo
  document.getElementById('start').addEventListener('click', () => {
    // Verifica se o jogador tocou 3 vezes r√°pidas (Easter Egg)
    checkTripleTap();
    
    // Inicia o jogo normalmente
    playerReset(); 
    update();
  });
  
  // Bot√£o de reiniciar
  document.getElementById('restart').addEventListener('click', () => {
    arena.forEach(row => row.fill(0)); 
    player.score = 0;
    player.lines = 0;
    player.combo = 0;
    turboMode = false; // üöÄ EASTER EGG: Reseta o modo turbo
    dropInterval = 1000; // üöÄ EASTER EGG: Restaura velocidade normal
    startButtonTaps = []; // üöÄ EASTER EGG: Limpa o array de toques
    playerReset(); 
    updateScore(); 
    gameOverScreen.style.display = 'none'; 
    gameOver = false;
  });
  
  // Bot√£o de pausar
  document.getElementById('pause').addEventListener('click', () => gameOver = !gameOver);

  // ========================================
  // RENDERIZA√á√ÉO DAS PE√áAS NO TUTORIAL
  // ========================================
  
  const instructionsCanvasList = document.querySelectorAll('.pieceCanvas');
  const piecesData = {
    'I': [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]],
    'O': [[2,2],[2,2]],
    'T': [[0,0,0],[1,1,1],[0,1,0]],
    'L': [[0,3,0],[0,3,0],[0,3,3]],
    'J': [[0,4,0],[0,4,0],[4,4,0]],
    'S': [[0,6,6],[6,6,0],[0,0,0]],
    'Z': [[7,7,0],[0,7,7],[0,0,0]],
  };

  // Desenha cada pe√ßa no tutorial
  instructionsCanvasList.forEach(canvas => {
    const ctx = canvas.getContext('2d');
    const pieceKey = canvas.getAttribute('data-piece');
    const matrix = piecesData[pieceKey];
    
    // Preenche o fundo
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const cellSize = 15;
    // Centraliza a pe√ßa
    const offsetX = (canvas.width - matrix[0].length * cellSize) / 2;
    const offsetY = (canvas.height - matrix.length * cellSize) / 2;

    // Desenha a pe√ßa
    matrix.forEach((row, y) => {
      row.forEach((val, x) => {
        if(val !== 0){
          ctx.fillStyle = `hsl(${val*45}, 80%, 60%)`;
          ctx.fillRect(offsetX + x*cellSize, offsetY + y*cellSize, cellSize, cellSize);
          ctx.strokeStyle = "#000";
          ctx.strokeRect(offsetX + x*cellSize, offsetY + y*cellSize, cellSize, cellSize);
        }
      });
    });
  });

  // Fecha o popup de instru√ß√µes e inicia o jogo
  document.getElementById('closeInstructions').addEventListener('click', () => {
    document.getElementById('instructionsPopup').style.display = 'none';
    playerReset();
    update();
  });

  // ========================================
  // MENU DROPDOWN DE CONFIGURA√á√ïES
  // ========================================
  
  const settingsToggle = document.getElementById('settingsToggle');
  const settingsContent = document.getElementById('settingsContent');

  // Alterna a visibilidade do menu
  settingsToggle.addEventListener('click', () => {
    const isVisible = settingsContent.style.display === 'block';
    settingsContent.style.display = isVisible ? 'none' : 'block';
  });

  // Fecha o menu ao clicar fora dele
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.menu-dropdown')) {
      settingsContent.style.display = 'none';
    }
  });

  // ========================================
  // CONTROLES DE M√öSICA
  // ========================================
  
  const bgMusic = document.getElementById('bgMusic');
  const musicPlay = document.getElementById('musicPlay');
  const musicPause = document.getElementById('musicPause');
  const musicVolume = document.getElementById('musicVolume');

  // Controles de reprodu√ß√£o
  musicPlay.addEventListener('click', () => bgMusic.play());
  musicPause.addEventListener('click', () => bgMusic.pause());
  musicVolume.addEventListener('input', (e) => bgMusic.volume = e.target.value);
</script>
</body>
</html>


