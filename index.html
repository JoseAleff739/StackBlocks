<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>StackBlocks</title> <!-- Nome do jogo -->

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Press Start 2P', monospace;
    }

    body {
      background-color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      color: #fff;
    }

    .game-container {
      background-color: rgba(0, 0, 0, 0.75);
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      grid-template-rows: auto auto;
      gap: 20px;
      padding: 20px;
      border-radius: 10px;
      max-width: 1000px;
      width: 90vw;
    }

    .sidebar, .next-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 10px;
      background-color: #111;
      border: 3px solid red;
      height: 600px;
      justify-content: flex-start;
      font-size: 14px;
      border-radius: 5px;
    }

    .sidebar div, .next-container canvas {
      background-color: #222;
      padding: 10px;
      border: 2px solid #555;
      text-align: center;
      border-radius: 3px;
    }

    canvas#tetris {
      background-color: #000;
      border: 4px solid #fff;
      border-radius: 5px;
    }

    .controls {
      grid-column: span 3;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      padding: 12px 20px;
      font-size: 14px;
      background-color: #222;
      color: #fff;
      border: 2px solid #fff;
      cursor: pointer;
      transition: background 0.2s ease;
      border-radius: 5px;
      user-select: none;
    }

    button:hover {
      background-color: #fff;
      color: #000;
    }

    button#start { border-color: #00ff00; }
    button#restart { border-color: orange; }
    button#pause { border-color: red; }

    #gameOverScreen {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.9);
      color: red;
      font-size: 32px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-family: 'Press Start 2P', monospace;
      display: none;
      z-index: 10;
    }

    #gameOverScreen p { margin-bottom: 20px; }

    /* MENU DE AUDIO SUSPENSO */
    .audio-dropdown {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }

    .audio-dropdown button {
      border: 2px solid #555;
      background-color: #222;
      color: #ccc;
      font-size: 12px;
      padding: 6px 12px;
      cursor: pointer;
    }

    .audio-dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      top: 30px;
      background-color: rgba(17,17,17,0.95);
      border: 2px solid #555;
      border-radius: 8px;
      padding: 10px;
      width: 150px;
      font-size: 12px;
      color: #ccc;
    }

    .audio-dropdown-content button {
      width: 100%;
      margin: 4px 0;
      font-size: 12px;
      padding: 4px 0;
    }

    .audio-dropdown-content input[type=range] {
      width: 100%;
    }

    /* POP-UP INSTRU√á√ïES */
    #instructionsPopup {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.95);
      color: #fff;
      font-family: 'Press Start 2P', monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 20;
    }

    #instructionsPopup div {
      background-color: #111;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 600px;
    }

    #instructionsPopup h2 {
      color: #00ff00;
      margin-bottom: 10px;
    }

    #instructionsPopup button {
      margin-top: 15px;
      border-color: #00ff00;
      color: #00ff00;
      background-color: #222;
    }

    #instructionsPopup button:hover {
      background-color: #00ff00;
      color: #000;
    }
  </style>
</head>
<body>

  <div class="game-container">
    <div class="sidebar">
      <div id="score">SCORE: <span>0</span></div>
      <div id="time">TIME: <span>0</span>s</div>
      <div id="lines">LINE: <span>0</span></div>
      <div id="combo">COMBO: <span>0</span></div>
    </div>

    <canvas id="tetris" width="300" height="600"></canvas>

    <div class="next-container">
      <canvas id="next" width="120" height="120"></canvas>
    </div>

    <div class="controls">
      <button id="left">‚óÄ</button>
      <button id="right">‚ñ∂</button>
      <button id="down">‚ñº</button>
      <button id="rotate">‚ü≥</button>
      <button id="start">START</button>
      <button id="pause">PAUSE</button>
      <button id="restart">RESTART</button>
    </div>
  </div>

  <div id="gameOverScreen">
    <p>GAME OVER</p>
    <p>Pressione tecla E para reiniciar</p>
  </div>

  <!-- POP-UP INSTRU√á√ïES INTERATIVO -->
  <div id="instructionsPopup">
    <div>
      <h2>Como Jogar</h2>
      <p>Objetivo: completar linhas para ganhar pontos!</p>
      <p>Use as setas do teclado para mover as pe√ßas:</p>
      <ul>
        <li>‚óÄ : Mover para esquerda</li>
        <li>‚ñ∂ : Mover para direita</li>
        <li>‚ñº : Descer r√°pido</li>
        <li>‚ü≥ ou ‚ñ≤ : Rotacionar pe√ßa</li>
      </ul>
      <p>Aqui est√£o algumas das pe√ßas que voc√™ vai encontrar:</p>
      <div style="display:flex; justify-content:space-around; margin:10px 0;">
        <canvas class="pieceCanvas" width="60" height="60" data-piece="H"></canvas>
        <canvas class="pieceCanvas" width="60" height="60" data-piece="I"></canvas>
        <canvas class="pieceCanvas" width="60" height="60" data-piece="J"></canvas>
        <canvas class="pieceCanvas" width="60" height="60" data-piece="K"></canvas>
      </div>
      <button id="closeInstructions">Vamos jogar!</button>
    </div>
  </div>

  <!-- √Åudio para queda da pe√ßa -->
  <audio id="pieceSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <!-- MUSICA DE FUNDO -->
  <audio id="bgMusic" src="https://files.catbox.moe/3pgllj.mp3" preload="auto" loop></audio>

  <!-- MENU DE AUDIO -->
  <div class="audio-dropdown">
    <button id="audioToggle">üéµ Trilha</button>
    <div class="audio-dropdown-content" id="audioContent">
      <p><strong>To Zanarkand</strong></p>
      <button id="musicPlay">‚ñ∂ Play</button>
      <button id="musicPause">‚è∏ Pausar</button>
      <label for="musicVolume">Volume:</label>
      <input type="range" id="musicVolume" min="0" max="1" step="0.01" value="0.5">
    </div>
  </div>

<script>
  // ==== CONFIGURA√á√ÉO INICIAL DO JOGO ====
  const canvas = document.getElementById('tetris');
  const ctx = canvas.getContext('2d');
  const nextCanvas = document.getElementById('next');
  const nextCtx = nextCanvas.getContext('2d');

  const scoreEl = document.querySelector('#score span');
  const timeEl = document.querySelector('#time span');
  const linesEl = document.querySelector('#lines span');
  const comboEl = document.querySelector('#combo span');
  const gameOverScreen = document.getElementById('gameOverScreen');

  let arena = createMatrix(10, 20);
  let dropCounter = 0;
  let dropInterval = 1000;
  let lastTime = 0;
  let startTime = 0;
  let gameOver = false;

  let player = {
    pos: {x:0,y:0},
    matrix: null,
    score:0,
    lines:0,
    combo:0,
    next: null
  };

  // ==== PE√áAS ====
  function createMatrix(w,h){
    const matrix = [];
    while(h--) matrix.push(new Array(w).fill(0));
    return matrix;
  }

  function createPiece(type){
    switch(type){
      case 'T': return [[0,0,0],[1,1,1],[0,1,0]];
      case 'O': return [[2,2],[2,2]];
      case 'L': return [[0,3,0],[0,3,0],[0,3,3]];
      case 'J': return [[0,4,0],[0,4,0],[4,4,0]];
      case 'I': return [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]];
      case 'S': return [[0,6,6],[6,6,0],[0,0,0]];
      case 'Z': return [[7,7,0],[0,7,7],[0,0,0]];
      default: return [[0]];
    }
  }

  function drawMatrix(matrix, offset, context){
    matrix.forEach((row,y)=>{
      row.forEach((value,x)=>{
        if(value!==0){
          context.fillStyle = `hsl(${value*45},80%,60%)`;
          context.fillRect((x+offset.x)*30, (y+offset.y)*30, 30, 30);
          context.strokeStyle = '#000';
          context.strokeRect((x+offset.x)*30, (y+offset.y)*30, 30, 30);
        }
      });
    });
  }

  function merge(arena, player){
    player.matrix.forEach((row,y)=>{
      row.forEach((value,x)=>{
        if(value!==0) arena[y+player.pos.y][x+player.pos.x]=value;
      });
    });
  }

  function collide(arena, player){
    const [m,o] = [player.matrix, player.pos];
    for(let y=0;y<m.length;y++){
      for(let x=0;x<m[y].length;x++){
        if(m[y][x]!==0 && (arena[y+o.y] && arena[y+o.y][x+o.x])!==0) return true;
      }
    }
    return false;
  }

  function playerDrop(){
    player.pos.y++;
    if(collide(arena, player)){
      player.pos.y--;
      merge(arena, player);
      playerReset();
      sweep();
      updateScore();
      document.getElementById('pieceSound').play();
    }
    dropCounter = 0;
  }

  function playerMove(dir){
    player.pos.x += dir;
    if(collide(arena, player)) player.pos.x -= dir;
  }

  function playerReset(){
    const pieces = 'ILJOTSZ';
    player.matrix = player.next || createPiece(pieces[pieces.length*Math.random()|0]);
    player.next = createPiece(pieces[pieces.length*Math.random()|0]);
    player.pos.y = 0;
    player.pos.x = (arena[0].length/2|0)-(player.matrix[0].length/2|0);
    if(collide(arena, player)){
      arena.forEach(row=>row.fill(0));
      player.score = 0;
      player.lines = 0;
      player.combo = 0;
      gameOverScreen.style.display='flex';
      gameOver=true;
    }
  }

  function rotate(matrix, dir){
    for(let y=0;y<matrix.length;y++){
      for(let x=0;x<y;x++){
        [matrix[x][y],matrix[y][x]]=[matrix[y][x],matrix[x][y]];
      }
    }
    if(dir>0) matrix.forEach(row=>row.reverse());
    else matrix.reverse();
  }

  function playerRotate(dir){
    rotate(player.matrix, dir);
    let offset = 1;
    while(collide(arena, player)){
      player.pos.x += offset;
      offset = -(offset+(offset>0?1:-1));
      if(offset>player.matrix[0].length){
        rotate(player.matrix, -dir);
        player.pos.x=0;
        return;
      }
    }
  }

  function sweep(){
    let rowCount = 1;
    outer: for(let y=arena.length-1;y>=0;y--){
      for(let x=0;x<arena[y].length;x++){
        if(arena[y][x]===0) continue outer;
      }
      const row = arena.splice(y,1)[0].fill(0);
      arena.unshift(row);
      player.score += rowCount*10;
      player.lines++;
      player.combo++;
      rowCount *= 2;
      y++;
    }
  }

  function updateScore(){
    scoreEl.innerText = player.score;
    linesEl.innerText = player.lines;
    comboEl.innerText = player.combo;
  }

  function update(time=0){
    const deltaTime = time - lastTime;
    lastTime = time;
    dropCounter += deltaTime;
    if(dropCounter>dropInterval && !gameOver) playerDrop();
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    drawMatrix(arena,{x:0,y:0},ctx);
    drawMatrix(player.matrix,player.pos,ctx);

    // ======= CORRE√á√ÉO DO BUG DA PR√ìXIMA PE√áA =======
    nextCtx.fillStyle = '#000';
    nextCtx.fillRect(0,0,nextCanvas.width,nextCanvas.height);
    if (player.next) {
      const blockSize = 20;
      const offsetX = Math.floor((nextCanvas.width - player.next[0].length * blockSize) / 2 / blockSize);
      const offsetY = Math.floor((nextCanvas.height - player.next.length * blockSize) / 2 / blockSize);
      player.next.forEach((row, y) => {
        row.forEach((value, x) => {
          if (value !== 0) {
            nextCtx.fillStyle = `hsl(${value * 45},80%,60%)`;
            nextCtx.fillRect((x + offsetX) * blockSize, (y + offsetY) * blockSize, blockSize, blockSize);
            nextCtx.strokeStyle = '#000';
            nextCtx.strokeRect((x + offsetX) * blockSize, (y + offsetY) * blockSize, blockSize, blockSize);
          }
        });
      });
    }
    // ===============================================

    requestAnimationFrame(update);
  }

  document.addEventListener('keydown', event=>{
    if(gameOver && event.key==='e'){ // Reiniciar
      gameOverScreen.style.display='none';
      gameOver=false;
      playerReset();
      updateScore();
      return;
    }
    if(event.key==='ArrowLeft') playerMove(-1);
    if(event.key==='ArrowRight') playerMove(1);
    if(event.key==='ArrowDown') playerDrop();
    if(event.key==='ArrowUp') playerRotate(1);
    if(event.key===' ') playerRotate(1);
  });

  document.getElementById('left').addEventListener('click',()=>playerMove(-1));
  document.getElementById('right').addEventListener('click',()=>playerMove(1));
  document.getElementById('down').addEventListener('click',()=>playerDrop());
  document.getElementById('rotate').addEventListener('click',()=>playerRotate(1));
  document.getElementById('start').addEventListener('click',()=>{playerReset(); update();});
  document.getElementById('restart').addEventListener('click',()=>{arena.forEach(row=>row.fill(0)); playerReset(); updateScore(); gameOverScreen.style.display='none'; gameOver=false;});
  document.getElementById('pause').addEventListener('click',()=>gameOver=!gameOver);

  // ==== POP-UP INTERATIVO ====
  const instructionsCanvasList = document.querySelectorAll('.pieceCanvas');
  const piecesData = {
    'H': [[0,8,8],[8,8,0]],
    'I': [[0,9,0],[9,9,9]],
    'J': [[10,0,0],[10,10,10]],
    'K': [[0,0,11],[11,11,11]],
  };

  instructionsCanvasList.forEach(canvas=>{
    const ctx = canvas.getContext('2d');
    const pieceKey = canvas.getAttribute('data-piece');
    const matrix = piecesData[pieceKey];
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    matrix.forEach((row,y)=>{
      row.forEach((val,x)=>{
        if(val!==0){
          ctx.fillStyle=`hsl(${val*45},80%,60%)`;
          ctx.fillRect(x*20, y*20, 20, 20);
          ctx.strokeStyle="#000";
          ctx.strokeRect(x*20, y*20, 20, 20);
        }
      });
    });
  });

  document.getElementById('closeInstructions').addEventListener('click',()=>{
    document.getElementById('instructionsPopup').style.display='none';
    playerReset();
    update();
  });

  // ==== √ÅUDIO ====
  const bgMusic = document.getElementById('bgMusic');
  const musicPlay = document.getElementById('musicPlay');
  const musicPause = document.getElementById('musicPause');
  const musicVolume = document.getElementById('musicVolume');

  musicPlay.addEventListener('click',()=>bgMusic.play());
  musicPause.addEventListener('click',()=>bgMusic.pause());
  musicVolume.addEventListener('input',(e)=>bgMusic.volume=e.target.value);

  const audioToggle = document.getElementById('audioToggle');
  const audioContent = document.getElementById('audioContent');
  audioToggle.addEventListener('click',()=>audioContent.style.display=audioContent.style.display==='block'?'none':'block');
</script>
</body>
</html>
